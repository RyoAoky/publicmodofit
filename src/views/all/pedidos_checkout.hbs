<section class="py-5">
    <div class="container">
        <h2 class="fw-bold mb-4"><i class="bi bi-credit-card me-2"></i>Finalizar Compra</h2>

        <form id="payment-form" onsubmit="return false;">
            <div class="row g-4">
                <div class="col-lg-8">
                    <!-- Datos del cliente -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-person me-2"></i>Datos de Contacto</h5>
                        </div>
                        <div class="card-body">
                            <div id="alert-login" class="alert alert-info" style="display: none;">
                                <i class="bi bi-info-circle me-2"></i>
                                <a href="/auth/login">Inicia sesión</a> para una experiencia más rápida o completa tus
                                datos:
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" id="nombre"
                                        data-openpay-card="holder_name_first" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido *</label>
                                    <input type="text" class="form-control" id="apellido"
                                        data-openpay-card="holder_name_last" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Correo electrónico *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Teléfono *</label>
                                    <input type="tel" class="form-control" id="telefono" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de Documento *</label>
                                    <select class="form-select" id="tipoDocumento" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="DNI">DNI</option>
                                        <option value="PASAPORTE">Pasaporte</option>
                                        <option value="CE">Carnet de Extranjería</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Número de Documento *</label>
                                    <input type="text" class="form-control" id="numeroDocumento"
                                        placeholder="Ingresa tu documento" required>
                                    <div class="form-text" id="docHelp">Selecciona el tipo de documento primero</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Método de pago - Solo Tarjeta -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-credit-card me-2"></i>Pago con Tarjeta</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3">
                                    <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" height="32"
                                        class="card-icon" id="icon-visa" style="transition: opacity 0.3s;">
                                    <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard"
                                        height="32" class="card-icon" id="icon-mastercard"
                                        style="transition: opacity 0.3s;">
                                    <img src="https://img.icons8.com/color/48/amex.png" alt="Amex" height="32"
                                        class="card-icon" id="icon-amex" style="transition: opacity 0.3s;">
                                </div>
                            </div>

                            <!-- Formulario de tarjeta OpenPay -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Nombre en la tarjeta *</label>
                                    <input type="text" class="form-control" id="holderName"
                                        placeholder="Como aparece en la tarjeta" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Número de tarjeta *</label>
                                    <input type="text" class="form-control" id="cardNumber"
                                        data-openpay-card="card_number" placeholder="1234 5678 9012 3456" maxlength="19"
                                        autocomplete="cc-number" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Mes *</label>
                                    <select class="form-select" id="expirationMonth"
                                        data-openpay-card="expiration_month" required>
                                        <option value="">Mes</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Año *</label>
                                    <select class="form-select" id="expirationYear" data-openpay-card="expiration_year"
                                        required>
                                        <option value="">Año</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="cvv" data-openpay-card="cvv2"
                                        placeholder="123" maxlength="4" autocomplete="cc-csc" required>
                                </div>
                            </div>

                            <!-- Campo oculto para device_session_id -->
                            <input type="hidden" name="deviceIdHiddenFieldName" id="deviceIdHiddenFieldName">

                            <div class="alert alert-light mt-3">
                                <i class="bi bi-shield-check me-2 text-success"></i>
                                <small>Tu información de pago está protegida con encriptación SSL</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h5 class="mb-0 fw-bold">Resumen del Pedido</h5>
                        </div>
                        <div class="card-body">
                            <div id="resumen-items">
                                <!-- Items del carrito -->
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span id="subtotal">S/ 0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>IGV (18%)</span>
                                <span id="igv">S/ 0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total a Pagar</span>
                                <span id="total" class="text-primary fs-4">S/ 0.00</span>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 p-3">
                            <button class="btn btn-success w-100 btn-lg" id="btn-pagar" onclick="procesarPago()">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Pedido
                            </button>
                            <a href="/pedidos/carrito" class="btn btn-outline-secondary w-100 mt-2">
                                <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Configuración OpenPay desde servidor -->
<input type="hidden" id="openpay-merchant-id" value="{{openpayMerchantId}}">
<input type="hidden" id="openpay-public-key" value="{{openpayPublicKey}}">
<input type="hidden" id="openpay-sandbox" value="{{openpayIsSandbox}}">

<!-- jQuery (requerido por OpenPay.js según documentación oficial) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<!-- OpenPay.js -->
<script src="https://js.openpay.pe/openpay.v1.min.js"></script>
<script src="https://js.openpay.pe/openpay-data.v1.min.js"></script>
<script>
    // Configuración OpenPay desde inputs hidden (renderizados por el servidor)
    const openpayMerchantId = document.getElementById('openpay-merchant-id').value;
    const openpayPublicKey = document.getElementById('openpay-public-key').value;
    const openpayIsSandbox = document.getElementById('openpay-sandbox').value === 'true';
    let openpayDeviceSessionId = '';

    let carrito = JSON.parse(localStorage.getItem('modofit_carrito')) || [];

    // Configuración de longitud de documentos
    const DOC_CONFIG = {
        'DNI': { min: 8, max: 8, pattern: /^\d{8}$/, help: 'DNI debe tener exactamente 8 dígitos' },
        'PASAPORTE': { min: 6, max: 9, pattern: /^[A-Za-z0-9]{6,9}$/, help: 'Pasaporte: 6-9 caracteres alfanuméricos' },
        'CE': { min: 9, max: 12, pattern: /^[A-Za-z0-9]{9,12}$/, help: 'Carnet de Extranjería: 9-12 caracteres' }
    };

    // Inicializar OpenPay (sin fetch, usa datos del servidor)
    function initOpenPay() {
        if (!openpayMerchantId || !openpayPublicKey) {
            console.error('Configuración de OpenPay no disponible');
            Swal.fire('Error', 'No se pudo cargar la configuración de pago', 'error');
            return;
        }

        OpenPay.setId(openpayMerchantId);
        OpenPay.setApiKey(openpayPublicKey);
        OpenPay.setSandboxMode(openpayIsSandbox);

        openpayDeviceSessionId = OpenPay.deviceData.setup("payment-form", "deviceIdHiddenFieldName");
        console.log("OpenPay inicializado correctamente", { merchantId: openpayMerchantId, sandbox: openpayIsSandbox });
    }

    // Llenar años de expiración
    function llenarAnios() {
        const select = document.getElementById('expirationYear');
        const currentYear = new Date().getFullYear();
        for (let i = 0; i < 15; i++) {
            const year = currentYear + i;
            const option = document.createElement('option');
            option.value = year.toString().slice(-2);
            option.textContent = year;
            select.appendChild(option);
        }
    }

    // Validación de documento de identidad
    document.getElementById('tipoDocumento').addEventListener('change', function (e) {
        const tipo = e.target.value;
        const inputDoc = document.getElementById('numeroDocumento');
        const helpText = document.getElementById('docHelp');

        if (tipo && DOC_CONFIG[tipo]) {
            const config = DOC_CONFIG[tipo];
            inputDoc.maxLength = config.max;
            inputDoc.placeholder = `${config.min === config.max ? config.min : config.min + '-' + config.max} caracteres`;
            helpText.textContent = config.help;
            inputDoc.value = ''; // Limpiar al cambiar tipo
        } else {
            inputDoc.maxLength = 20;
            inputDoc.placeholder = 'Ingresa tu documento';
            helpText.textContent = 'Selecciona el tipo de documento primero';
        }
    });

    document.getElementById('numeroDocumento').addEventListener('input', function (e) {
        const tipo = document.getElementById('tipoDocumento').value;
        if (tipo === 'DNI') {
            // Solo números para DNI
            e.target.value = e.target.value.replace(/\D/g, '');
        } else {
            // Alfanumérico para pasaporte y CE (mayúsculas)
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        }
    });

    // --- NUEVO: Event Listeners para validación en tiempo real y detección de marca ---

    // 1. Detectar tipo de tarjeta mientras escribe
    document.getElementById('cardNumber').addEventListener('keyup', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value.replace(/(\d{4})(?=\d)/g, '$1 ').trim();

        // Método oficial: OpenPay.card.cardType(numero_limpio)
        const cardType = OpenPay.card.cardType(value);

        // Feedback visual (Opcional: puedes agregar clases CSS para resaltar el icono)
        resaltarIconoTarjeta(cardType);
    });

    // Helper para iconos (necesitas poner IDs a tus imagenes en el HTML)
    function resaltarIconoTarjeta(type) {
        // Resetear opacidad
        document.querySelectorAll('.card-icon').forEach(img => img.style.opacity = '0.3');

        // Mapeo de lo que devuelve OpenPay a tus IDs (ajusta según tus imagenes)
        if (type === 'Visa') document.getElementById('icon-visa').style.opacity = '1';
        else if (type === 'Mastercard') document.getElementById('icon-mastercard').style.opacity = '1';
        else if (type === 'American Express') document.getElementById('icon-amex').style.opacity = '1';
        else document.querySelectorAll('.card-icon').forEach(img => img.style.opacity = '1'); // Si no detecta, muestra todas
    }

    // 2. Solo números en CVV
    document.getElementById('cvv').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });

    // --- FIN NUEVO ---

    function renderResumen() {
        const container = document.getElementById('resumen-items');
        if (!container) return; // Validación por seguridad

        let html = '';
        carrito.forEach(item => {
            html += `
            <div class="d-flex justify-content-between mb-2">
                <span>${item.nombre} x${item.cantidad}</span>
                <span>S/ ${(item.precio * item.cantidad).toFixed(2)}</span>
            </div>
        `;
        });

        container.innerHTML = html;

        const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        const igv = subtotal * 0.18;

        document.getElementById('subtotal').textContent = 'S/ ' + (subtotal - igv).toFixed(2);
        document.getElementById('igv').textContent = 'S/ ' + igv.toFixed(2);
        document.getElementById('total').textContent = 'S/ ' + subtotal.toFixed(2);
    }

    // --- VALIDACIÓN MEJORADA CON OPENPAY ---
    function validarFormulario() {
        // Datos de contacto básicos
        const nombre = document.getElementById('nombre').value.trim();
        const apellido = document.getElementById('apellido').value.trim();
        const email = document.getElementById('email').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const tipoDocumento = document.getElementById('tipoDocumento').value;
        const numeroDocumento = document.getElementById('numeroDocumento').value.trim();

        if (!nombre || !apellido || !email || !telefono) {
            Swal.fire('Faltan datos', 'Por favor completa todos los datos de contacto', 'warning');
            return false;
        }

        // Validar documento de identidad
        if (!tipoDocumento) {
            Swal.fire('Falta documento', 'Selecciona el tipo de documento', 'warning');
            return false;
        }

        if (!numeroDocumento) {
            Swal.fire('Falta documento', 'Ingresa el número de documento', 'warning');
            return false;
        }

        const docConfig = DOC_CONFIG[tipoDocumento];
        if (docConfig && !docConfig.pattern.test(numeroDocumento)) {
            Swal.fire('Documento inválido', docConfig.help, 'warning');
            document.getElementById('numeroDocumento').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('numeroDocumento').classList.remove('is-invalid');
        }

        // Datos de tarjeta
        const holderName = document.getElementById('holderName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const expirationMonth = document.getElementById('expirationMonth').value;
        const expirationYear = document.getElementById('expirationYear').value;
        const cvv = document.getElementById('cvv').value;

        if (!holderName) {
            Swal.fire('Error', 'Ingresa el nombre del titular de la tarjeta', 'warning');
            return false;
        }

        // 1. Validar Número de Tarjeta (Algoritmo Luhn y longitud por marca)
        if (!OpenPay.card.validateCardNumber(cardNumber)) {
            Swal.fire('Tarjeta Inválida', 'El número de tarjeta no es válido o no es aceptado.', 'error');
            document.getElementById('cardNumber').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('cardNumber').classList.remove('is-invalid');
        }

        // 2. Validar Fecha de Expiración
        if (!OpenPay.card.validateExpiry(expirationMonth, expirationYear)) {
            Swal.fire('Fecha Inválida', 'La tarjeta ha expirado o la fecha es incorrecta.', 'error');
            return false;
        }

        // 3. Validar CVC (Requiere el número de tarjeta para saber si debe ser 3 o 4 dígitos)
        if (!OpenPay.card.validateCVC(cvv, cardNumber)) {
            Swal.fire('CVV Inválido', 'El código de seguridad no es correcto para este tipo de tarjeta.', 'error');
            return false;
        }

        return true;
    }

    async function procesarPago() {
        // Si la validación falla, se detiene aquí
        if (!validarFormulario()) return;

        // Verificar que hay un plan en el carrito
        const planItem = carrito.find(item => item.tipo === 'plan');
        if (!planItem) {
            Swal.fire('Error', 'No hay un plan de suscripción en el carrito', 'warning');
            return;
        }

        // Obtener valores limpios nuevamente
        const holderName = document.getElementById('holderName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const expirationMonth = document.getElementById('expirationMonth').value;
        const expirationYear = document.getElementById('expirationYear').value;
        const cvv = document.getElementById('cvv').value;

        // Datos auxiliares
        const nombre = document.getElementById('nombre').value.trim();
        const apellido = document.getElementById('apellido').value.trim();
        const email = document.getElementById('email').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const tipoDocumento = document.getElementById('tipoDocumento').value;
        const numeroDocumento = document.getElementById('numeroDocumento').value.trim();

        // --- FIX: Validar si tenemos la información completa del plan (codplanext) ---
        // Si el usuario tenía el carrito guardado desde antes de una actualización, puede faltar este dato.
        if (!planItem.codplanext && planItem.idplanpas) {
            try {
                // Intentar recuperar el ID externo del plan
                const response = await fetch('/pedidos/api/membresias');
                const result = await response.json();
                if (result.success && result.data) {
                    const planActualizado = result.data.find(p => p.idplanpas == planItem.idplanpas);
                    if (planActualizado && planActualizado.codplanext) {
                        planItem.codplanext = planActualizado.codplanext;
                        console.log('Plan actualizado con ID externo:', planItem.codplanext);

                        // Actualizar localStorage para futuras referencia
                        const index = carrito.findIndex(i => i.idplanpas == planItem.idplanpas);
                        if (index !== -1) {
                            carrito[index].codplanext = planActualizado.codplanext;
                            localStorage.setItem('modofit_carrito', JSON.stringify(carrito));
                        }
                    }
                }
            } catch (err) {
                console.warn('No se pudo verificar el plan externo:', err);
            }
        }

        Swal.fire({
            title: 'Procesando suscripción...',
            html: '<p>Validando datos y conectando con OpenPay...</p><p class="text-muted small">Esto puede tomar unos segundos</p>',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // Crear token de tarjeta
        OpenPay.token.create({
            card_number: cardNumber,
            holder_name: holderName,
            expiration_year: expirationYear,
            expiration_month: expirationMonth,
            cvv2: cvv
        }, async function (response) {
            // SUCCESS CALLBACK - Token creado
            try {
                const token_id = response.data.id;

                Swal.update({
                    html: '<p>Token generado. Creando suscripción...</p>'
                });

                // Enviar a backend para el flujo completo de suscripción
                const suscripcionResponse = await fetch('/pedidos/api/procesar-suscripcion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tokenTarjeta: token_id,
                        deviceSessionId: openpayDeviceSessionId,
                        datosCliente: {
                            nombre,
                            apellido,
                            email,
                            telefono,
                            tipoDocumento,
                            numeroDocumento
                        },
                        // Datos del Plan (aplanados como espera el controlador)
                        planId: planItem.codplanext,
                        idplanpas: planItem.idplanpas,
                        montoPlan: planItem.precio,
                        barcpro: planItem.id
                    })
                });

                const data = await suscripcionResponse.json();

                if (data.success) {
                    localStorage.removeItem('modofit_carrito');
                    Swal.fire({
                        icon: 'success',
                        title: '¡Suscripción Exitosa!',
                        html: `
                        <p>Tu membresía <strong>${planItem.nombre}</strong> ha sido activada.</p>
                        <p class="text-muted small">ID Suscripción: ${data.datos.suscripcion.idsuscext}</p>
                    `,
                        confirmButtonText: 'Ver mi Dashboard'
                    }).then(() => {
                        window.location.href = '/dashboard/membresias';
                    });
                } else {
                    console.error("Error Backend:", data);
                    Swal.fire('Error', data.message || 'No se pudo procesar la suscripción', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Error de Conexión', 'Hubo un problema al comunicarse con el servidor.', 'error');
            }
        }, function (error) {
            // ERROR CALLBACK (OpenPay rechaza crear el token)
            console.error("Error OpenPay Token:", error);
            let mensaje = 'No se pudo procesar la tarjeta.';

            if (error.data && error.data.description) {
                mensaje = error.data.description;
            } else if (error.message) {
                mensaje = error.message;
            }

            Swal.fire('Error en Tarjeta', mensaje, 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (carrito.length === 0) {
            // window.location.href = '/pedidos'; // Descomentar en producción
            console.log("Carrito vacío");
        }
        renderResumen();
        llenarAnios();
        initOpenPay();
    });
</script>