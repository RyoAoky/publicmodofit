<style>
    .section-header {
        padding: 140px 0 60px;
        background: var(--bg-dark);
        text-align: center;
    }

    .section-header h1 {
        font-size: 48px;
        color: #fff;
        margin-bottom: 10px;
    }

    .section-checkout {
        padding: 40px 0 100px;
        background: var(--bg-dark);
    }

    .checkout-row {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
    }

    .checkout-form-box {
        flex: 2;
        min-width: 300px;
    }

    .checkout-summary-box {
        flex: 1;
        min-width: 280px;
    }

    .checkout-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        margin-bottom: 25px;
    }

    .checkout-card-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .checkout-card-header i {
        color: var(--accent-color);
        font-size: 20px;
    }

    .checkout-card-header h5 {
        color: #fff;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
    }

    .checkout-card-body {
        padding: 25px;
    }

    .form-label {
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }

    .form-control, .form-select {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        color: #fff;
        border-radius: 0;
        padding: 14px 16px;
        font-size: 14px;
    }

    .form-control:focus, .form-select:focus {
        background: var(--bg-surface);
        border-color: var(--accent-color);
        color: #fff;
        box-shadow: 0 0 0 3px var(--primary-color-transparent);
    }

    .form-control::placeholder {
        color: #555;
    }

    .form-text {
        color: #666;
        font-size: 11px;
    }

    .alert-login {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-left: 3px solid var(--accent-color);
        color: var(--text-muted);
        padding: 15px 20px;
        margin-bottom: 20px;
    }

    .alert-login a {
        color: var(--accent-color);
        font-weight: 600;
    }

    .card-icons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .card-icons img {
        height: 32px;
        opacity: 0.4;
        transition: opacity 0.3s;
    }

    .card-icons img.active {
        opacity: 1;
    }

    .security-notice {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        padding: 15px 20px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .security-notice i {
        color: #28a745;
        font-size: 20px;
    }

    .security-notice span {
        font-size: 13px;
        color: var(--text-muted);
    }

    .summary-card {
        position: sticky;
        top: 100px;
    }

    .summary-items {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border-color);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        color: var(--text-muted);
        font-size: 14px;
    }

    .summary-totals {
        padding: 20px 25px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        color: var(--text-muted);
    }

    .summary-row.total {
        border-top: 1px solid var(--border-color);
        margin-top: 10px;
        padding-top: 20px;
    }

    .summary-row.total span:last-child {
        color: var(--accent-color);
        font-size: 26px;
        font-family: "Poppins", sans-serif;
        font-weight: 700;
    }

    .btn-pay {
        display: block;
        width: 100%;
        background: #28a745;
        border: 1px solid #28a745;
        color: #fff;
        font-family: "Poppins", sans-serif;
        font-weight: 800;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 18px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-pay:hover {
        background: #218838;
        border-color: #218838;
    }

    .btn-back {
        display: block;
        width: 100%;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 14px;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s;
        margin-top: 12px;
    }

    .btn-back:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .iconos-titulo {
        margin: 20px 0;
    }

    .iconos-titulo i {
        color: var(--accent-color);
        font-size: 4px;
        margin: 0 5px;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }
</style>

<!-- Header -->
<section class="section-header">
    <div class="container">
        <h1><i class="bi bi-credit-card me-3"></i>FINALIZAR COMPRA</h1>
        <div class="iconos-titulo">
            <i class="bi bi-circle-fill"></i>
            <i class="bi bi-circle-fill"></i>
            <i class="bi bi-circle-fill"></i>
        </div>
    </div>
</section>

<!-- Checkout Section -->
<section class="section-checkout">
    <div class="container">
        <form id="payment-form" onsubmit="return false;">
            <div class="checkout-row">
                <!-- Form -->
                <div class="checkout-form-box">
                    <!-- Contact Data -->
                    <div class="checkout-card">
                        <div class="checkout-card-header">
                            <i class="bi bi-person"></i>
                            <h5>Datos de Contacto</h5>
                        </div>
                        <div class="checkout-card-body">
                            <div id="alert-login" class="alert-login" style="display: none;">
                                <i class="bi bi-info-circle me-2"></i>
                                <a href="/auth/login">Inicia sesión</a> para una experiencia más rápida o completa tus datos:
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" id="nombre" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Apellido *</label>
                                    <input type="text" class="form-control" id="apellido" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Correo electrónico *</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Teléfono *</label>
                                    <input type="tel" class="form-control" id="telefono" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de Documento *</label>
                                    <select class="form-select" id="tipoDocumento" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="DNI">DNI</option>
                                        <option value="PASAPORTE">Pasaporte</option>
                                        <option value="CE">Carnet de Extranjería</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Número de Documento *</label>
                                    <input type="text" class="form-control" id="numeroDocumento" placeholder="Ingresa tu documento" required>
                                    <div class="form-text" id="docHelp">Selecciona el tipo de documento primero</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="checkout-card">
                        <div class="checkout-card-header">
                            <i class="bi bi-credit-card"></i>
                            <h5>Pago con Tarjeta</h5>
                        </div>
                        <div class="checkout-card-body">
                            <div class="card-icons">
                                <img src="https://img.icons8.com/color/48/visa.png" alt="Visa" id="icon-visa" class="card-icon">
                                <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard" id="icon-mastercard" class="card-icon">
                                <img src="https://img.icons8.com/color/48/amex.png" alt="Amex" id="icon-amex" class="card-icon">
                            </div>

                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Nombre en la tarjeta *</label>
                                    <input type="text" class="form-control" id="holderName" placeholder="Como aparece en la tarjeta" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Número de tarjeta *</label>
                                    <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" autocomplete="cc-number" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Mes *</label>
                                    <select class="form-select" id="expirationMonth" required>
                                        <option value="">Mes</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Año *</label>
                                    <select class="form-select" id="expirationYear" required>
                                        <option value="">Año</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4" autocomplete="cc-csc" required>
                                </div>
                            </div>

                            <input type="hidden" name="deviceIdHiddenFieldName" id="deviceIdHiddenFieldName">

                            <div class="security-notice">
                                <i class="bi bi-shield-check"></i>
                                <span>Tu información de pago está protegida con encriptación SSL</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="checkout-summary-box">
                    <div class="checkout-card summary-card">
                        <div class="checkout-card-header">
                            <h5>Resumen del Pedido</h5>
                        </div>
                        {{#if hasPreselectedPlan}}
                        <div class="summary-items">
                            <div class="summary-item">
                                <span>{{planData.planName}}</span>
                                <span>{{planData.currency}} {{planData.price}}</span>
                            </div>
                            {{#if planData.description}}
                            <div style="padding: 10px 0; color: var(--text-muted); font-size: 12px;">
                                {{planData.description}}
                            </div>
                            {{/if}}
                            {{#if planData.duration}}
                            <div style="padding: 5px 0; color: var(--text-muted); font-size: 12px;">
                                <i class="bi bi-calendar-check me-1"></i> Duración: {{planData.duration}} días
                            </div>
                            {{/if}}
                            {{#if planData.trialDays}}
                            <div style="padding: 5px 0; color: var(--accent-color); font-size: 12px;">
                                <i class="bi bi-gift me-1"></i> {{planData.trialDays}} días de prueba gratis
                            </div>
                            {{/if}}
                        </div>
                        {{else}}
                        <div class="summary-items" id="resumen-items">
                            <!-- Items loaded via JS -->
                        </div>
                        {{/if}}
                        <div class="summary-totals">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="subtotal">{{#if hasPreselectedPlan}}{{planData.currency}} {{formatPrecioSinIGV planData.price}}{{else}}S/ 0.00{{/if}}</span>
                            </div>
                            <div class="summary-row">
                                <span>IGV (18%)</span>
                                <span id="igv">{{#if hasPreselectedPlan}}{{planData.currency}} {{formatIGV planData.price}}{{else}}S/ 0.00{{/if}}</span>
                            </div>
                            <div class="summary-row total">
                                <span style="color: #fff; font-weight: 600;">Total a Pagar</span>
                                <span id="total">{{#if hasPreselectedPlan}}{{planData.currency}} {{planData.price}}{{else}}S/ 0.00{{/if}}</span>
                            </div>
                        </div>
                        <div style="padding: 0 25px 25px;">
                            <button class="btn-pay" id="btn-pagar" onclick="procesarPago()">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Pedido
                            </button>
                            {{#if hasPreselectedPlan}}
                            <a href="/#planes" class="btn-back">
                                <i class="bi bi-arrow-left me-2"></i>Volver a Planes
                            </a>
                            {{else}}
                            <a href="/pedidos/carrito" class="btn-back">
                                <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                            </a>
                            {{/if}}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- OpenPay Config -->
<input type="hidden" id="openpay-merchant-id" value="{{openpayMerchantId}}">
<input type="hidden" id="openpay-public-key" value="{{openpayPublicKey}}">
<input type="hidden" id="openpay-sandbox" value="{{openpayIsSandbox}}">

<!-- Plan Data -->
{{#if hasPreselectedPlan}}
<input type="hidden" id="plan-data" value="{{json planData}}">
<input type="hidden" id="has-preselected-plan" value="true">
{{else}}
<input type="hidden" id="has-preselected-plan" value="false">
{{/if}}

<!-- Scripts -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="https://js.openpay.pe/openpay.v1.min.js"></script>
<script src="https://js.openpay.pe/openpay-data.v1.min.js"></script>

<script>
const openpayMerchantId = document.getElementById('openpay-merchant-id').value;
const openpayPublicKey = document.getElementById('openpay-public-key').value;
const openpayIsSandbox = document.getElementById('openpay-sandbox').value === 'true';
const hasPreselectedPlan = document.getElementById('has-preselected-plan').value === 'true';
let openpayDeviceSessionId = '';
let carrito = [];
let planData = null;

// Initialize cart and plan data
if (hasPreselectedPlan) {
    try {
        planData = JSON.parse(document.getElementById('plan-data').value);
        // Create cart item from plan data
        carrito = [{
            id: planData.planId,
            nombre: planData.planName,
            precio: planData.price,
            cantidad: 1,
            moneda: planData.currency,
            descripcion: planData.description
        }];
    } catch (error) {
        console.error('Error parsing plan data:', error);
        carrito = JSON.parse(localStorage.getItem('modofit_carrito')) || [];
    }
} else {
    carrito = JSON.parse(localStorage.getItem('modofit_carrito')) || [];
}

const DOC_CONFIG = {
    'DNI': { min: 8, max: 8, pattern: /^\d{8}$/, help: 'DNI debe tener exactamente 8 dígitos' },
    'PASAPORTE': { min: 6, max: 9, pattern: /^[A-Za-z0-9]{6,9}$/, help: 'Pasaporte: 6-9 caracteres alfanuméricos' },
    'CE': { min: 9, max: 12, pattern: /^[A-Za-z0-9]{9,12}$/, help: 'Carnet de Extranjería: 9-12 caracteres' }
};

function initOpenPay() {
    if (!openpayMerchantId || !openpayPublicKey) {
        console.error('Configuración de OpenPay no disponible');
        return;
    }
    OpenPay.setId(openpayMerchantId);
    OpenPay.setApiKey(openpayPublicKey);
    OpenPay.setSandboxMode(openpayIsSandbox);
    openpayDeviceSessionId = OpenPay.deviceData.setup("payment-form", "deviceIdHiddenFieldName");
}

function llenarAnios() {
    const select = document.getElementById('expirationYear');
    const currentYear = new Date().getFullYear();
    for (let i = 0; i < 15; i++) {
        const year = currentYear + i;
        const option = document.createElement('option');
        option.value = year.toString().slice(-2);
        option.textContent = year;
        select.appendChild(option);
    }
}

document.getElementById('tipoDocumento').addEventListener('change', function(e) {
    const tipo = e.target.value;
    const inputDoc = document.getElementById('numeroDocumento');
    const helpText = document.getElementById('docHelp');
    if (tipo && DOC_CONFIG[tipo]) {
        const config = DOC_CONFIG[tipo];
        inputDoc.maxLength = config.max;
        inputDoc.placeholder = `${config.min === config.max ? config.min : config.min + '-' + config.max} caracteres`;
        helpText.textContent = config.help;
        inputDoc.value = '';
    }
});

document.getElementById('numeroDocumento').addEventListener('input', function(e) {
    const tipo = document.getElementById('tipoDocumento').value;
    if (tipo === 'DNI') {
        e.target.value = e.target.value.replace(/\D/g, '');
    } else {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    }
});

document.getElementById('cardNumber').addEventListener('keyup', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    e.target.value = value.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
    const cardType = OpenPay.card.cardType(value);
    resaltarIconoTarjeta(cardType);
});

function resaltarIconoTarjeta(type) {
    document.querySelectorAll('.card-icon').forEach(img => img.style.opacity = '0.4');
    if (type === 'Visa') document.getElementById('icon-visa').style.opacity = '1';
    else if (type === 'Mastercard') document.getElementById('icon-mastercard').style.opacity = '1';
    else if (type === 'American Express') document.getElementById('icon-amex').style.opacity = '1';
    else document.querySelectorAll('.card-icon').forEach(img => img.style.opacity = '1');
}

document.getElementById('cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

function renderResumen() {
    // Skip rendering if we have a preselected plan (already rendered server-side)
    if (hasPreselectedPlan) {
        return;
    }
    
    const container = document.getElementById('resumen-items');
    if (!container) return;
    
    let html = '';
    carrito.forEach(item => {
        html += `<div class="summary-item"><span>${item.nombre} x${item.cantidad}</span><span>S/ ${(item.precio * item.cantidad).toFixed(2)}</span></div>`;
    });
    container.innerHTML = html;
    
    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const igv = subtotal * 0.18;
    document.getElementById('subtotal').textContent = 'S/ ' + (subtotal - igv).toFixed(2);
    document.getElementById('igv').textContent = 'S/ ' + igv.toFixed(2);
    document.getElementById('total').textContent = 'S/ ' + subtotal.toFixed(2);
}

function validarFormulario() {
    const nombre = document.getElementById('nombre').value.trim();
    const apellido = document.getElementById('apellido').value.trim();
    const email = document.getElementById('email').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    const tipoDocumento = document.getElementById('tipoDocumento').value;
    const numeroDocumento = document.getElementById('numeroDocumento').value.trim();
    
    if (!nombre || !apellido || !email || !telefono) {
        Swal.fire({title: 'Faltan datos', text: 'Por favor completa todos los datos de contacto', icon: 'warning', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    if (!tipoDocumento || !numeroDocumento) {
        Swal.fire({title: 'Falta documento', text: 'Ingresa tu documento de identidad', icon: 'warning', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    const docConfig = DOC_CONFIG[tipoDocumento];
    if (docConfig && !docConfig.pattern.test(numeroDocumento)) {
        Swal.fire({title: 'Documento inválido', text: docConfig.help, icon: 'warning', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    const holderName = document.getElementById('holderName').value.trim();
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const expirationMonth = document.getElementById('expirationMonth').value;
    const expirationYear = document.getElementById('expirationYear').value;
    const cvv = document.getElementById('cvv').value;
    
    if (!holderName) {
        Swal.fire({title: 'Error', text: 'Ingresa el nombre del titular', icon: 'warning', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    if (!OpenPay.card.validateCardNumber(cardNumber)) {
        Swal.fire({title: 'Tarjeta Inválida', text: 'El número de tarjeta no es válido', icon: 'error', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    if (!OpenPay.card.validateExpiry(expirationMonth, expirationYear)) {
        Swal.fire({title: 'Fecha Inválida', text: 'La tarjeta ha expirado', icon: 'error', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    if (!OpenPay.card.validateCVC(cvv, cardNumber)) {
        Swal.fire({title: 'CVV Inválido', text: 'El código de seguridad no es válido', icon: 'error', background: '#0a0a0a', color: '#BCBCBC'});
        return false;
    }
    
    return true;
}

function procesarPago() {
    if (!validarFormulario()) return;
    
    const btn = document.getElementById('btn-pagar');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
    
    // OpenPay token generation and payment processing...
    // (Mantener la lógica original de pago)
    
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Confirmar Pedido';
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    initOpenPay();
    llenarAnios();
    renderResumen();
});
</script>
