<section class="py-5">
    <div class="container">
        <h2 class="fw-bold mb-4"><i class="bi bi-credit-card me-2"></i>Finalizar Compra</h2>

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Datos del cliente -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent border-0 py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-person me-2"></i>Datos de Contacto</h5>
                    </div>
                    <div class="card-body">
                        {{#if user}}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="nombre" value="{{user.nomcli}}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="apellido" value="{{user.apecli}}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Correo electrónico</label>
                                <input type="email" class="form-control" id="email" value="{{user.emailcli}}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" value="{{user.celcli}}" readonly>
                            </div>
                        </div>
                        {{else}}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <a href="/auth/login">Inicia sesión</a> para una experiencia más rápida o completa tus datos:
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Apellido *</label>
                                <input type="text" class="form-control" id="apellido" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Correo electrónico *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="telefono" required>
                            </div>
                        </div>
                        {{/if}}
                    </div>
                </div>

                <!-- Método de pago -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-wallet2 me-2"></i>Método de Pago</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="metodoPago" id="pago-efectivo" value="efectivo" checked>
                                    <label class="form-check-label w-100 text-center" for="pago-efectivo">
                                        <i class="bi bi-cash-coin fs-2 text-success d-block mb-2"></i>
                                        <strong>Efectivo</strong>
                                        <small class="text-muted d-block">Paga en el local</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="metodoPago" id="pago-yape" value="yape">
                                    <label class="form-check-label w-100 text-center" for="pago-yape">
                                        <i class="bi bi-phone fs-2 text-primary d-block mb-2"></i>
                                        <strong>Yape / Plin</strong>
                                        <small class="text-muted d-block">Transferencia móvil</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check card p-3 h-100">
                                    <input class="form-check-input" type="radio" name="metodoPago" id="pago-tarjeta" value="tarjeta">
                                    <label class="form-check-label w-100 text-center" for="pago-tarjeta">
                                        <i class="bi bi-credit-card fs-2 text-info d-block mb-2"></i>
                                        <strong>Tarjeta</strong>
                                        <small class="text-muted d-block">Débito o crédito</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Datos de Yape -->
                        <div id="datos-yape" class="mt-4" style="display: none;">
                            <div class="alert alert-light border">
                                <div class="row align-items-center">
                                    <div class="col-md-6 text-center">
                                        <img src="/img/qr-yape.png" alt="QR Yape" class="img-fluid" style="max-width: 200px;" onerror="this.style.display='none'">
                                        <p class="mt-2 mb-0"><strong>Número Yape:</strong> 963 061 209</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">1. Realiza la transferencia al número indicado</p>
                                        <p class="mb-2">2. Guarda el comprobante</p>
                                        <p class="mb-0">3. Te confirmaremos por WhatsApp</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Datos de Tarjeta -->
                        <div id="datos-tarjeta" class="mt-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Número de tarjeta</label>
                                    <input type="text" class="form-control" id="numeroTarjeta" placeholder="1234 5678 9012 3456">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de vencimiento</label>
                                    <input type="text" class="form-control" id="fechaTarjeta" placeholder="MM/AA">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvvTarjeta" placeholder="123">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-header bg-transparent border-0 py-3">
                        <h5 class="mb-0 fw-bold">Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div id="resumen-items">
                            <!-- Items del carrito -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span id="subtotal">S/ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IGV (18%)</span>
                            <span id="igv">S/ 0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total a Pagar</span>
                            <span id="total" class="text-primary fs-4">S/ 0.00</span>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0 p-3">
                        <button class="btn btn-success w-100 btn-lg" id="btn-pagar" onclick="procesarPago()">
                            <i class="bi bi-check-circle me-2"></i>Confirmar Pedido
                        </button>
                        <a href="/pedidos/carrito" class="btn btn-outline-secondary w-100 mt-2">
                            <i class="bi bi-arrow-left me-2"></i>Volver al Carrito
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
let carrito = JSON.parse(localStorage.getItem('modofit_carrito')) || [];

function renderResumen() {
    const container = document.getElementById('resumen-items');
    let html = '';
    
    carrito.forEach(item => {
        html += `
            <div class="d-flex justify-content-between mb-2">
                <span>${item.nombre} x${item.cantidad}</span>
                <span>S/ ${(item.precio * item.cantidad).toFixed(2)}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const igv = subtotal * 0.18;
    
    document.getElementById('subtotal').textContent = 'S/ ' + (subtotal - igv).toFixed(2);
    document.getElementById('igv').textContent = 'S/ ' + igv.toFixed(2);
    document.getElementById('total').textContent = 'S/ ' + subtotal.toFixed(2);
}

// Mostrar/ocultar opciones de pago
document.querySelectorAll('input[name="metodoPago"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('datos-yape').style.display = this.value === 'yape' ? 'block' : 'none';
        document.getElementById('datos-tarjeta').style.display = this.value === 'tarjeta' ? 'block' : 'none';
    });
});

async function procesarPago() {
    const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;
    const nombre = document.getElementById('nombre').value;
    const apellido = document.getElementById('apellido').value;
    const email = document.getElementById('email').value;
    const telefono = document.getElementById('telefono').value;
    
    if (!nombre || !apellido || !email || !telefono) {
        Swal.fire('Error', 'Por favor completa todos los campos', 'error');
        return;
    }
    
    const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    
    Swal.fire({
        title: 'Procesando...',
        text: 'Por favor espera',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    try {
        const response = await fetch('/pedidos/procesar-pago', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                items: carrito,
                metodoPago,
                datosCliente: { nombre, apellido, email, telefono },
                total
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            localStorage.removeItem('modofit_carrito');
            Swal.fire({
                icon: 'success',
                title: '¡Pedido Confirmado!',
                text: 'Tu pedido #' + data.idPedido + ' ha sido registrado',
                confirmButtonText: 'Ver Confirmación'
            }).then(() => {
                window.location.href = '/pedidos/confirmacion/' + data.idPedido;
            });
        } else {
            Swal.fire('Error', data.message, 'error');
        }
    } catch (error) {
        Swal.fire('Error', 'Hubo un problema al procesar tu pedido', 'error');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (carrito.length === 0) {
        window.location.href = '/pedidos';
    }
    renderResumen();
});
</script>
